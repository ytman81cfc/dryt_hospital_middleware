<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hospital.middleware.healthplatform.dao.his.HealthplatfromDAO">
    <select id="queryMzsfmxbsf" resultType="java.util.HashMap">
        select distinct a.orgcode                                        "YLJGDM",--	医疗机构代码	VARCHAR	22	必填	复合主键：采用22位“卫生机构代码”
                        a.FEEID                                          "SFMXLSH",--	收费明细流水号	VARCHAR	32	必填	复合主键
                        a.TRANSTYPE                                      "TFBZ",--	退费标志	VARCHAR	1	必填	复合主键：1：收费 2：退费
                        a.orgname                                        "YLJGMC",--	医疗机构名称	VARCHAR	70	必填	医院执业许可第一名称
                        '0'                                              "FYDM",--	分院代码	VARCHAR	20	必填	记录分院代码（内码）,如无分院，则传0
                        ''                                               "FYMC",--	分院名称	VARCHAR	120	条件必填	分院代码不为0时必填
                        a.CHRG_BCHNO                                     "SFLSH",--	收费流水号	VARCHAR	64	必填	关联收费记录表
                        a.regid                                          "JZLSH",--	就诊流水号	VARCHAR	32	必填	与《门诊就诊记录表》关联
                        a.INVOICENO                                      "FPH",--	发票号	VARCHAR	64	必填	未结算费用填写默认值“/”,已结算费用填写发票号。
                        '8'                                              "KLX",--	卡类型	VARCHAR	16	必填	请按照以下优先级顺序填写：1：患者主索引号、2：身份证号、3：医保卡号，如果都没有则填写门诊就诊流水号
                        c.rid                                            "KH",--	卡号	VARCHAR	64	必填
                        f.item_id                                        "ZJLX",--	证件类型	VARCHAR	2		参见CV02.01.101-2022修订版 身份证件类别代码		优先使用身份证
                        d.certno                                         "ZJHM",--	证件号码	VARCHAR	32
                        substr(e.NAME, 0, 10)                                           "XM",--	姓名	VARCHAR	50	必填
                        d.DEPTCODE                                       "YNJZKSDM",--	院内费用发生科室代码	VARCHAR	50	必填
                        nvl(d.DEPTNAME, '-')                                       "YNJZKSMC",--	院内费用发生科室名称	VARCHAR	100	必填
                        j.item_id                                        "JZKSDM",--	中心费用发生科室代码	VARCHAR	50	必填	参见《全民健康信息平台科室分类代码表》
                        j.item_name                                      "JZKSMC",--	中心费用发生科室名称	VARCHAR	100	必填	参见《全民健康信息平台科室分类代码表》
                        a.EXECDPCD                                       "YNZXKSBM",--	院内执行科室编码	VARCHAR	50
                        a.EXECDPNM                                       "YNZXKSMC",--	院内执行科室名称	VARCHAR	100
                        k.item_id                                        "ZXKSBM",--	中心执行科室编码	VARCHAR	50		参见《全民健康信息平台科室分类代码表》
                        k.item_name                                      "ZXKSMC",--	中心执行科室名称	VARCHAR	100		参见《全民健康信息平台科室分类代码表》
                        '100'                                            "JZLXDM",--	就诊类型代码	VARCHAR	3	必填	参见 CVA5101_01就诊类型代码
                        case
                            when d.PAYKINDCODE = '01' then '07'
                            when d.PAYKINDCODE = '02' and d.INSUTYPE = 'A' then '01'
                            when d.PAYKINDCODE = '02' and d.INSUTYPE = 'B' then '02'
                            else '99' end                                "BXLX",--	医疗费用支付方式	VARCHAR	4	必填	参见 CV07.10.003-2022修订版 医疗费用来源类别
                        m.item_id                                        "MXFYLB",--	明细费用类别	VARCHAR	2	必填	参见 CVA5105明细费用类别
                        decode(a.DRUGFLAG, '1', '0', '2', '1', '3', '1') "MXXMLB",--	明细项目类别	VARCHAR	1	必填	0：药品 1：项目
                        to_char(a.FEEDATE, 'YYYY-MM-DD HH24:MI:SS')      "STFSJ",--	收退费时间	DATETIME		必填
                        decode(a.DRUGFLAG, '1', a.GJYPID, '-')           "YPID",--	国家药品ID	VARCHAR	64	条件必填	明细项目类别为“药品”时填写	三级医院必填,二级医院有条件的填 填写国家药管平台药品采购唯一性识别码YPID（V8.3）	V8.3版本中不包含的药品填“-”。
                        a.ITEMCODE                                       "MXXMBM",--	院内明细项目编码	VARCHAR	128	必填
                        a.ITEMNAME                                       "MXXMMC",--	院内明细项目名称	VARCHAR	128	必填
                        nvl(replace(i.MED_LIST_CODG, '_SI', ''), '999')  "ZXDM",--	中心明细项目代码	VARCHAR	32	必填	耗材、服务项目参见《全民健康信息平台医疗服务项目价格表》药品参见医保码		草药和自制剂参见《全民健康信息平台制剂、中草药医保编码》。	其他填写999
                        nvl(i.SERVITEM_NAME, a.itemname)                 "ZXMC",--	中心明细项目名称	VARCHAR	200	必填
                        nvl(a.SPECS, '-')                                          "MXXMGG",--	明细项目规格	VARCHAR	32	必填
                        a.PRICEUNIT                                      "MXXMDW",--	明细项目单位	VARCHAR	32	必填
                        round(a.UNITPRICE, 3)                            "MXXMDJ",--	明细项目单价	NUMERIC	18,3	必填
                        round(a.QTY, 3)                                  "MXXMSL",--	明细项目数量	NUMERIC	10,3	必填
                        round(a.TOTCOST, 3)                              "MXXMJE",--	明细项目金额	NUMERIC	18,3	必填	退费标志为2（退费）时，传负数
                        a.FEEOPCD                                        "SFCZYGH",--	收费操作员工号	VARCHAR	64	必填
                        nvl(a.FEENAME, '-')                                        "SFCZYXM",--	收费操作员姓名	VARCHAR	50	必填
                        g.certno                                         "SFCZYSFZHM",--	收费操作员身份证号码	VARCHAR	18
                        to_char(sysdate, 'YYYY-MM-DD')                   "TBRQ" --	填报日期	DATETIME	 必填	本条数据采集时间，格式YYYY-MM-DD
        from (select a.*, d.invocode, b.GJYPID, h.orgname
              from OPB_FEEDETAIL a
                       join
                   com_hospitalinfo h on a.orgcode = h.orgcode
                       join
                   (select orgcode, itemcode, feecode, '' GJYPID
                    from fin_undruginfo
                    where isvalid = '1'
                      and isstop = '0'
                    union all
                    select orgcode, drugcode, feecode, GJYPID
                    from pha_druginfo
                    where isvalid = '1'
                      and isstop = '0'
                    union all
                    select orgcode, MEDLISTCODG, feecode, '' GJYPID
                    from pha_medcon
                    where isvalid = '1'
                      and isstop = '0'
                   ) b on a.orgcode = b.orgcode and a.itemcode = b.itemcode
                       join com_feetype c on c.orgcode = b.orgcode and c.feecode = b.feecode
                       join com_fee_invo_compare d
                            on d.orgcode = c.orgcode and d.feecode = c.feecode and d.statcode = 'MZ01') a
                 left join (select a.item_id, a.item_name, b.his_item_id
                            from si_yt_report_item a,
                                 si_yt_report_item_compare b
                            where a.module_rid = b.module_rid
                              and a.type_rid = b.type_rid
                              and a.rid = b.item_rid
                              and a.module_rid = '202310101511361148853000000000'
                              and a.type_rid = '202311141512391328016800000000'
                              and b.orgcode=#{orgcode}) k on k.his_item_id = a.EXECDPCD
                 left join fin_item_compare i on i.orgcode = a.orgcode and i.ITEMCODE = a.ITEMCODE
                 left join com_userinfo g on a.orgcode = g.orgcode and a.FEEOPCD = g.usercode
                 left join (select a.item_id, b.his_item_id
                            from si_yt_report_item a,
                                 si_yt_report_item_compare b
                            where a.module_rid = b.module_rid
                              and a.type_rid = b.type_rid
                              and a.rid = b.item_rid
                              and a.module_rid = '202310101511361148853000000000'
                              and a.type_rid = '202311271641491389287500000000'
                              and b.orgcode=#{orgcode}) m on m.his_item_id = a.invocode,
             OPB_INVOICEINFO e,
             com_patientinfo c,
             opr_register d
                 left join (select a.item_id, b.his_item_id
                            from si_yt_report_item a,
                                 si_yt_report_item_compare b
                            where a.module_rid = b.module_rid
                              and a.type_rid = b.type_rid
                              and a.rid = b.item_rid
                              and a.module_rid = '202310101511361148853000000000'
                              and a.type_rid = '202310101602441149584100000000') f on f.his_item_id = d.PSNCERTTYPE
                 left join (select a.item_id, a.item_name, b.his_item_id
                            from si_yt_report_item a,
                                 si_yt_report_item_compare b
                            where a.module_rid = b.module_rid
                              and a.type_rid = b.type_rid
                              and a.rid = b.item_rid
                              and a.module_rid = '202310101511361148853000000000'
                              and a.type_rid = '202311141512391328016800000000'
                              and b.orgcode=#{orgcode}) j on j.his_item_id = d.DEPTCODE
        where a.orgcode = d.orgcode
          and a.regid = d.regid
          and d.orgcode = c.orgcode
          and d.patientno = c.patientno
          and d.patientid = c.patientid
          and a.orgcode = e.orgcode
          and a.regid = e.regid
          and a.INVOICENO = e.INVOICENO
          and a.TRANSTYPE = e.TRANSTYPE
          and a.TRANSTYPE = '1'
          and a.orgcode = #{orgcode}
          and to_char(a.FEEDATE, 'yyyy-mm-dd hh24:mi:ss') &gt;= #{begtime}
          and to_char(a.FEEDATE, 'yyyy-mm-dd hh24:mi:ss') &lt;= #{endtime}
    </select>

    <select id="queryMzsfmxbtf" resultType="java.util.HashMap">
        select distinct a.orgcode                                        "YLJGDM",--	医疗机构代码	VARCHAR	22	必填	复合主键：采用22位“卫生机构代码”
                        a.FEEID                                          "SFMXLSH",--	收费明细流水号	VARCHAR	32	必填	复合主键
                        a.TRANSTYPE                                      "TFBZ",--	退费标志	VARCHAR	1	必填	复合主键：1：收费 2：退费
                        a.orgname                                        "YLJGMC",--	医疗机构名称	VARCHAR	70	必填	医院执业许可第一名称
                        '0'                                              "FYDM",--	分院代码	VARCHAR	20	必填	记录分院代码（内码）,如无分院，则传0
                        ''                                               "FYMC",--	分院名称	VARCHAR	120	条件必填	分院代码不为0时必填
                        a.CHRG_BCHNO                                     "SFLSH",--	收费流水号	VARCHAR	64	必填	关联收费记录表
                        a.regid                                          "JZLSH",--	就诊流水号	VARCHAR	32	必填	与《门诊就诊记录表》关联
                        a.INVOICENO                                      "FPH",--	发票号	VARCHAR	64	必填	未结算费用填写默认值“/”,已结算费用填写发票号。
                        '8'                                              "KLX",--	卡类型	VARCHAR	16	必填	请按照以下优先级顺序填写：1：患者主索引号、2：身份证号、3：医保卡号，如果都没有则填写门诊就诊流水号
                        c.rid                                            "KH",--	卡号	VARCHAR	64	必填
                        f.item_id                                        "ZJLX",--	证件类型	VARCHAR	2		参见CV02.01.101-2022修订版 身份证件类别代码		优先使用身份证
                        d.certno                                         "ZJHM",--	证件号码	VARCHAR	32
                        substr(e.NAME, 0, 10)                                           "XM",--	姓名	VARCHAR	50	必填
                        d.DEPTCODE                                       "YNJZKSDM",--	院内费用发生科室代码	VARCHAR	50	必填
                        nvl(d.DEPTNAME, '-')                                       "YNJZKSMC",--	院内费用发生科室名称	VARCHAR	100	必填
                        j.item_id                                        "JZKSDM",--	中心费用发生科室代码	VARCHAR	50	必填	参见《全民健康信息平台科室分类代码表》
                        j.item_name                                      "JZKSMC",--	中心费用发生科室名称	VARCHAR	100	必填	参见《全民健康信息平台科室分类代码表》
                        a.EXECDPCD                                       "YNZXKSBM",--	院内执行科室编码	VARCHAR	50
                        a.EXECDPNM                                       "YNZXKSMC",--	院内执行科室名称	VARCHAR	100
                        k.item_id                                        "ZXKSBM",--	中心执行科室编码	VARCHAR	50		参见《全民健康信息平台科室分类代码表》
                        k.item_name                                      "ZXKSMC",--	中心执行科室名称	VARCHAR	100		参见《全民健康信息平台科室分类代码表》
                        '100'                                            "JZLXDM",--	就诊类型代码	VARCHAR	3	必填	参见 CVA5101_01就诊类型代码
                        case
                            when d.PAYKINDCODE = '01' then '07'
                            when d.PAYKINDCODE = '02' and d.INSUTYPE = 'A' then '01'
                            when d.PAYKINDCODE = '02' and d.INSUTYPE = 'B' then '02'
                            else '99' end                                "BXLX",--	医疗费用支付方式	VARCHAR	4	必填	参见 CV07.10.003-2022修订版 医疗费用来源类别
                        m.item_id                                        "MXFYLB",--	明细费用类别	VARCHAR	2	必填	参见 CVA5105明细费用类别
                        decode(a.DRUGFLAG, '1', '0', '2', '1', '3', '1') "MXXMLB",--	明细项目类别	VARCHAR	1	必填	0：药品 1：项目
                        to_char(a.FEEDATE, 'YYYY-MM-DD HH24:MI:SS')      "STFSJ",--	收退费时间	DATETIME		必填
                        decode(a.DRUGFLAG, '1', a.GJYPID, '-')           "YPID",--	国家药品ID	VARCHAR	64	条件必填	明细项目类别为“药品”时填写	三级医院必填,二级医院有条件的填 填写国家药管平台药品采购唯一性识别码YPID（V8.3）	V8.3版本中不包含的药品填“-”。
                        a.ITEMCODE                                       "MXXMBM",--	院内明细项目编码	VARCHAR	128	必填
                        a.ITEMNAME                                       "MXXMMC",--	院内明细项目名称	VARCHAR	128	必填
                        nvl(replace(i.MED_LIST_CODG, '_SI', ''), '999')  "ZXDM",--	中心明细项目代码	VARCHAR	32	必填	耗材、服务项目参见《全民健康信息平台医疗服务项目价格表》药品参见医保码		草药和自制剂参见《全民健康信息平台制剂、中草药医保编码》。	其他填写999
                        nvl(i.SERVITEM_NAME, a.itemname)                 "ZXMC",--	中心明细项目名称	VARCHAR	200	必填
                        nvl(a.SPECS, '-')                                          "MXXMGG",--	明细项目规格	VARCHAR	32	必填
                        a.PRICEUNIT                                      "MXXMDW",--	明细项目单位	VARCHAR	32	必填
                        round(a.UNITPRICE, 3)                            "MXXMDJ",--	明细项目单价	NUMERIC	18,3	必填
                        round(a.QTY, 3)                                  "MXXMSL",--	明细项目数量	NUMERIC	10,3	必填
                        round(a.TOTCOST, 3)                              "MXXMJE",--	明细项目金额	NUMERIC	18,3	必填	退费标志为2（退费）时，传负数
                        a.FEEOPCD                                        "SFCZYGH",--	收费操作员工号	VARCHAR	64	必填
                        nvl(a.FEENAME, '-')                                        "SFCZYXM",--	收费操作员姓名	VARCHAR	50	必填
                        g.certno                                         "SFCZYSFZHM",--	收费操作员身份证号码	VARCHAR	18
                        to_char(sysdate, 'YYYY-MM-DD')                   "TBRQ" --	填报日期	DATETIME	 必填	本条数据采集时间，格式YYYY-MM-DD
        from (select a.*, d.invocode, b.GJYPID, h.orgname
              from OPB_FEEDETAIL a
                       join
                   com_hospitalinfo h on a.orgcode = h.orgcode
                       join
                   (select orgcode, itemcode, feecode, '' GJYPID
                    from fin_undruginfo
                    where isvalid = '1'
                      and isstop = '0'
                    union all
                    select orgcode, drugcode, feecode, GJYPID
                    from pha_druginfo
                    where isvalid = '1'
                      and isstop = '0'
                    union all
                    select orgcode, MEDLISTCODG, feecode, '' GJYPID
                    from pha_medcon
                    where isvalid = '1'
                      and isstop = '0'
                   ) b on a.orgcode = b.orgcode and a.itemcode = b.itemcode
                       join com_feetype c on c.orgcode = b.orgcode and c.feecode = b.feecode
                       join com_fee_invo_compare d
                            on d.orgcode = c.orgcode and d.feecode = c.feecode and d.statcode = 'MZ01') a
                 left join (select a.item_id, a.item_name, b.his_item_id
                            from si_yt_report_item a,
                                 si_yt_report_item_compare b
                            where a.module_rid = b.module_rid
                              and a.type_rid = b.type_rid
                              and a.rid = b.item_rid
                              and a.module_rid = '202310101511361148853000000000'
                              and a.type_rid = '202311141512391328016800000000'
                              and b.orgcode=#{orgcode}) k on k.his_item_id = a.EXECDPCD
                 left join fin_item_compare i on i.orgcode = a.orgcode and i.ITEMCODE = a.ITEMCODE
                 left join com_userinfo g on a.orgcode = g.orgcode and a.FEEOPCD = g.usercode
                 left join (select a.item_id, b.his_item_id
                            from si_yt_report_item a,
                                 si_yt_report_item_compare b
                            where a.module_rid = b.module_rid
                              and a.type_rid = b.type_rid
                              and a.rid = b.item_rid
                              and a.module_rid = '202310101511361148853000000000'
                              and a.type_rid = '202311271641491389287500000000'
                              and b.orgcode=#{orgcode}) m on m.his_item_id = a.invocode,
             OPB_INVOICEINFO e,
             com_patientinfo c,
             opr_register d
                 left join (select a.item_id, b.his_item_id
                            from si_yt_report_item a,
                                 si_yt_report_item_compare b
                            where a.module_rid = b.module_rid
                              and a.type_rid = b.type_rid
                              and a.rid = b.item_rid
                              and a.module_rid = '202310101511361148853000000000'
                              and a.type_rid = '202310101602441149584100000000') f on f.his_item_id = d.PSNCERTTYPE
                 left join (select a.item_id, a.item_name, b.his_item_id
                            from si_yt_report_item a,
                                 si_yt_report_item_compare b
                            where a.module_rid = b.module_rid
                              and a.type_rid = b.type_rid
                              and a.rid = b.item_rid
                              and a.module_rid = '202310101511361148853000000000'
                              and a.type_rid = '202311141512391328016800000000'
                              and b.orgcode=#{orgcode}) j on j.his_item_id = d.DEPTCODE
        where a.orgcode = d.orgcode
          and a.regid = d.regid
          and d.orgcode = c.orgcode
          and d.patientno = c.patientno
          and d.patientid = c.patientid
          and a.orgcode = e.orgcode
          and a.regid = e.regid
          and a.INVOICENO = e.INVOICENO
          and a.TRANSTYPE = e.TRANSTYPE
          and a.TRANSTYPE = '2'
          and a.orgcode = #{orgcode}
          and to_char(a.FEEDATE, 'yyyy-mm-dd hh24:mi:ss') &gt;= #{begtime}
          and to_char(a.FEEDATE, 'yyyy-mm-dd hh24:mi:ss') &lt;= #{endtime}
    </select>

</mapper>